name: AI Code Review

on:
  pull_request:
    branches:
      - master

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install gh jq -y

      - name: Get list of changed files
        run: |
          gh pr diff ${{ github.event.pull_request.number }} --name-only > files.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize review output
        run: echo "## 🤖 AI Code Review Summary\n" > review.md

      - name: Analyze code changes
        run: |
          while IFS= read -r file; do
            if [[ ! "$file" =~ \.(js|ts|tsx|php|py)$ ]]; then
              echo "⏭️ Skipping unsupported file: $file"
              continue
            fi

            echo "🔍 Reviewing $file..."
            gh pr diff ${{ github.event.pull_request.number }} -- "$file" > file.diff

            split -l 100 file.diff chunk_

            for chunk_file in chunk_*; do
              DIFF=$(jq -Rs . < "$chunk_file")

              echo "{
                \"model\": \"qwen2.5-coder:7b\",
                \"messages\": [
                  {
                    \"role\": \"system\",
                    \"content\": \"Provide code feedback in format: 'FILE: $file LINE X: suggestion'. Be concise. Focus on potential bugs, performance issues, and code smells.\"
                  },
                  {
                    \"role\": \"user\",
                    \"content\": $DIFF
                  }
                ]
              }" > payload.json

              RESPONSE=$(curl -s -X POST "$OPENWEBUI_API_URL" \
                -H "Authorization: Bearer $OPENWEBUI_TOKEN" \
                -H "Content-Type: application/json" \
                -d @payload.json)

              # Extract suggestions and append to review.md
              echo "$RESPONSE" | jq -r '.choices[0].message.content' >> review.md
            done

            rm -f chunk_* payload.json
          done < files.txt

          # Post single comment with all suggestions
          if [ -s review.md ]; then
            echo -e "\n\n_Generated by AI Code Review Action_" >> review.md
            echo "=== Review Content ==="
            cat review.md
            echo "======================"
            ESCAPED_BODY=$(jq -Rs . < review.md)
            gh pr comment ${{ github.event.pull_request.number }} --body "$ESCAPED_BODY"
          else
            echo "No suggestions generated"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENWEBUI_API_URL: ${{ secrets.OPENWEBUI_API_URL }}
          OPENWEBUI_TOKEN: ${{ secrets.OPENWEBUI_TOKEN }}