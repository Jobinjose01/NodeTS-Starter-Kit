name: AI Code Review

on:
  pull_request:
    branches:
      - master

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install gh jq -y

      - name: Get list of changed files
        run: |
          gh pr diff ${{ github.event.pull_request.number }} --name-only > files.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize review output file
        run: echo "## ü§ñ AI Code Review\n" > review.md

      - name: Analyze and comment on code changes
        run: |
          while IFS= read -r file; do
            if [[ ! "$file" =~ \.(js|ts|tsx|php|py)$ ]]; then
              echo "‚è≠Ô∏è Skipping unsupported file: $file"
              continue
            fi

            echo "üîç Reviewing $file..."
            gh pr diff ${{ github.event.pull_request.number }} -- "$file" > file.diff

            split -l 100 file.diff chunk_

            for chunk_file in chunk_*; do
              DIFF=$(jq -Rs . < "$chunk_file")

              echo "{
                \"model\": \"qwen2.5-coder:7b\",
                \"messages\": [
                  {
                    \"role\": \"system\",
                    \"content\": \"You are an expert code reviewer. Please analyze the following code diff and suggest line-by-line improvements. Include the line numbers where possible.\"
                  },
                  {
                    \"role\": \"user\",
                    \"content\": $DIFF
                  }
                ]
              }" > payload.json

              RESPONSE=$(curl -s -X POST "$OPENWEBUI_API_URL" \
                -H "Authorization: Bearer $OPENWEBUI_TOKEN" \
                -H "Content-Type: application/json" \
                -d @payload.json)

              while IFS= read -r line; do
                LINE_NUMBER=$(echo "$line" | grep -oP "Line \K\d+")
                COMMENT=$(echo "$line" | sed 's/Line [0-9]*: //')

                if [ ! -z "$LINE_NUMBER" ] && [ ! -z "$COMMENT" ]; then
                  echo "üìù Commenting on line $LINE_NUMBER: $COMMENT"
                  gh pr review ${{ github.event.pull_request.number }} -r --body "$COMMENT"
                fi
              done <<< "$RESPONSE"

            done

            rm -f chunk_* payload.json
          done < files.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENWEBUI_API_URL: ${{ secrets.OPENWEBUI_API_URL }}
          OPENWEBUI_TOKEN: ${{ secrets.OPENWEBUI_TOKEN }}

